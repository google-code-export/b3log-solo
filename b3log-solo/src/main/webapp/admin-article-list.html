<div id="articlePanel">
    <div id="articleList">
    </div>
    <div id="articlePagination">
    </div>
    <div id="comments" class="none">
    </div>
    <div class="clear"></div>
</div>
<script type="text/javascript">
    var currentPage = 1;
    $("#articleList").table({
        resizable: true,
        colModel: [{
                name: "选择",
                index: "selected",
                width: 46,
                inputType: "checkbox",
                textAlign: "center",
                allSelected: true
            }, {
                name: "${titleLabel}",
                index: "title",
                minWidth: 180,
                style: "padding-left: 6px;"
            }, {
                textAlign: "center",
                name: "${createDateLabel}",
                index: "date",
                width: 130
            }, {
                textAlign: "center",
                name: "${updateLabel}",
                index: "update",
                width: 60,
                bindEvent: [{
                        'eventName': 'click',
                        'functionName': 'updateArticle'
                    }],
                style: "cursor:pointer;"
            }, {
                textAlign: "center",
                name: "${removeLabel}",
                index: "deleted",
                width: 60,
                bindEvent: [{
                        'eventName': 'click',
                        'functionName': 'deleteArticle'
                    }],
                style: "cursor:pointer;"
            }, {
                textAlign: "center",
                name: "${commentLabel}",
                index: "comments",
                width: 60,
                bindEvent: [{
                        'eventName': 'click',
                        'functionName': 'popComments'
                    }],
                style: "cursor:pointer;"
            }, {
                visible: false,
                index: "id"
            }]
    });

    var articlePagination = $("#articlePagination").paginate({
        bindEvent: "getArticleList",
        pageCount: 10,
        windowSize: 5,
        currentPage: 1,
        style: "google",
        isGoTo: false
    });

    var updateArticle = function (event) {
        $("#content").load("admin-article.do", '', function () {
            var requestJSONObject = {
                "oId": event.data.id[0]
            };

            var result = jsonRpc.articleService.getArticle(requestJSONObject);
            switch (result.sc) {
                case "GET_ARTICLE_SUCC":
                    setCurrentNaviStyle(0);

                    KE.init({
                        id : "articleContent",
                        items : ['fontname', 'fontsize', '|', 'textcolor', 'bgcolor', 'bold', 'italic', 'underline',
                            'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist',
                            'insertunorderedlist', '|', 'emoticons', 'image', 'link']
                    });

                    KE.create("articleContent");

                    // set default value for article.
                    $("#title").val(result.article.articleTitle).data('oId', event.data.id[0]);
                    KE.html("articleContent", result.article.articleContent)
                    $("#abstract").val(result.article.articleAbstract);

                    var tags = result.article.articleTags,
                    tagsString = '';
                    for (var i = 0; i < tags.length; i++) {
                        if (0 === i) {
                            tagsString = tags[i].tagTitle;
                        } else {
                            tagsString += "," + tags[i].tagTitle;
                        }
                    }
                    $("#tag").val(tagsString);
                        
                    break;
                case "GET_ARTICLE_FAIL_":
                    break;
                default:
                    break;
            }
        });
    }
    
    var deleteArticle = function (event) {
        var isDelete = confirm("${confirmRemoveLabel}");
        
        if (isDelete) {
            var requestJSONObject = {
                "oId": event.data.id[0]
            };

            var result = jsonRpc.articleService.removeArticle(requestJSONObject);
            
            switch (result.sc) {
                case "REMOVE_ARTICLE_SUCC":
                    $("#tipMsg").text("${removeSuccLabel}");
                    getArticleList(1);
                    break;
                case "REMOVE_ARTICLE_FAIL_":
                    $("#tipMsg").text("${removeFailLabel}");
                    break;
                default:
                    break;
            }
        }
    }

    var popComments = function (event) {
        $("#comments").data("oId", event.data.id[0]);
        getComment();
        $("#comments").dialog({
            width: 400
        });
    }
    
    var getArticleList = function (pageNum) {
        currentPage = pageNum;
        var requestJSONObject = {
            "paginationCurrentPageNum": pageNum,
            "paginationPageSize": 10,
            "paginationWindowSize": 10
        };
        
        var result = jsonRpc.articleService.getArticles(requestJSONObject);
        switch (result.sc) {
            case "GET_ARTICLES_SUCC":
                var articles = result.articles,
                articleData = [];

                for (var i = 0; i < articles.length; i++) {
                    articleData[i] = {};
                    articleData[i].selected = false;
                    articleData[i].title = articles[i].articleTitle;
                    articleData[i].date = $.bowknot.getDate(articles[i].articleCreateDate.time, 1);
                    articleData[i].update = "update";
                    articleData[i].deleted = "delete";
                    articleData[i].comments = "count(" + articles[i].articleCommentCount + ")";
                    articleData[i].id = articles[i].oId;
                }

                $("#articleList").table({
                    update:{
                        data: articleData
                    }
                });

                if (result.pagination.paginationPageCount === 0) {
                    result.pagination.paginationPageCount = 1;
                }
                
                articlePagination.paginate({
                    update: {
                        pageCount: result.pagination.paginationPageCount
                    }
                });
                break;
            default:
                break;
        }
    }
    getArticleList(1);

    var getComment = function () {
        var result = jsonRpc.commentService.getComments({"oId": $("#comments").data("oId")});
        switch (result.sc) {
            case "GET_COMMENTS_SUCC":
                var comments = result.comments,
                commentsHTML = '';
                for (var i = 0; i < comments.length; i++) {
                    commentsHTML += "<div class='comment-title'><span class='left'>" + comments[i].commentDate
                        + "</span><span class='right pointer' onclick=\"deleteComment('" + comments[i].oId
                        + "')\">delete</span><div class='clear'></div></div><div class='comment-body'>" + comments[i].commentContent + "</div>";
                }
                if (commentsHTML === "") {
                    commentsHTML = "占无评论！"
                }
                $("#comments").html(commentsHTML);
                break;
            default:
                break;
        };
    }

    var deleteComment = function (id) {
        var result = jsonRpc.commentService.removeComment({"oId": id});
        switch (result.sc) {
            case "REMOVE_COMMENT_SUCC":
                $("#tipMsg").text("${removeSuccLabel}");
                getComment();
                break;
            default:
                break;
        }

        getArticleList(currentPage);
    }
</script>